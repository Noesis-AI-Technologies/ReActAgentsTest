# 06_ReActAgentHILApiMultiSessionStreamTest

## é¡¹ç›®ç®€ä»‹

è¿™æ˜¯åŸºäº05é¡¹ç›®åˆ›å»ºçš„æ”¯æŒæµå¼è¿”å›çš„ReActæ™ºèƒ½ä½“é¡¹ç›®ã€‚æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¿æŒä¸å˜ï¼Œä¸»è¦æ·»åŠ äº†æµå¼è¿”å›åŠŸèƒ½ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿå®æ—¶çœ‹åˆ°AIçš„å›å¤è¿‡ç¨‹ï¼Œè€Œä¸æ˜¯ç­‰å¾…å®Œæ•´å›å¤åæ‰æ˜¾ç¤ºã€‚

## ä¸»è¦ç‰¹æ€§

### ğŸ†• æ–°å¢åŠŸèƒ½
- **æµå¼è¿”å›**: æ”¯æŒå®æ—¶æ˜¾ç¤ºAIçš„æ–‡æœ¬å›å¤ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- **åŒæ¨¡å¼æ”¯æŒ**: ç”¨æˆ·å¯ä»¥é€‰æ‹©æµå¼æ¨¡å¼æˆ–æ™®é€šæ¨¡å¼
- **å®æ—¶å·¥å…·è°ƒç”¨æç¤º**: åœ¨æµå¼æ¨¡å¼ä¸‹å®æ—¶æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€
- **Server-Sent Events (SSE)**: ä½¿ç”¨æ ‡å‡†çš„SSEåè®®å®ç°æµå¼ä¼ è¾“

### ğŸ“‹ ç»§æ‰¿åŠŸèƒ½
- å¤šç”¨æˆ·å¤šä¼šè¯æ”¯æŒ
- Human-in-the-loop (HIL) å·¥å…·å®¡æŸ¥
- é•¿æœŸè®°å¿†ç®¡ç†
- ä¼šè¯çŠ¶æ€ç®¡ç†
- Redisä¼šè¯å­˜å‚¨
- PostgreSQLæ•°æ®æŒä¹…åŒ–
- MCPå·¥å…·é›†æˆ

## æŠ€æœ¯å®ç°

### åç«¯æ”¹åŠ¨
1. **æ–°å¢æµå¼APIç«¯ç‚¹**: `/agent/invoke/stream`
2. **StreamChunkæ•°æ®æ¨¡å‹**: å®šä¹‰æµå¼å“åº”å—ç»“æ„
3. **æµå¼å¤„ç†å‡½æ•°**: åŸºäºLangGraphçš„`astream`æ–¹æ³•å®ç°
4. **SSEå“åº”**: ä½¿ç”¨FastAPIçš„StreamingResponse

### å‰ç«¯æ”¹åŠ¨
1. **å¼‚æ­¥æµå¼å®¢æˆ·ç«¯**: ä½¿ç”¨aiohttpå¤„ç†æµå¼å“åº”
2. **å®æ—¶æ˜¾ç¤º**: é€å­—ç¬¦æ˜¾ç¤ºAIå›å¤
3. **æ¨¡å¼é€‰æ‹©**: ç”¨æˆ·å¯é€‰æ‹©æµå¼æˆ–æ™®é€šæ¨¡å¼
4. **å·¥å…·è°ƒç”¨æç¤º**: å®æ—¶æ˜¾ç¤ºå·¥å…·ä½¿ç”¨çŠ¶æ€

## æµå¼è¿”å›æ¨¡å¼è¯´æ˜

### æµå¼å—ç±»å‹
- `text_chunk`: AIç”Ÿæˆçš„æ–‡æœ¬å†…å®¹ç‰‡æ®µï¼ˆçœŸæ­£çš„tokençº§åˆ«æµå¼ï¼‰
- `tool_call`: å·¥å…·è°ƒç”¨é€šçŸ¥ï¼ˆéæµå¼ï¼Œä½†å®æ—¶é€šçŸ¥ï¼‰
- `interrupt`: æ™ºèƒ½ä½“æ‰§è¡Œä¸­æ–­
- `completed`: æ‰§è¡Œå®Œæˆ
- `error`: æ‰§è¡Œé”™è¯¯

### æµå¼ç­–ç•¥
- **AIæ–‡æœ¬å›å¤**: ä½¿ç”¨LangGraphçš„`messages`æµå¼æ¨¡å¼ï¼Œå®ç°çœŸæ­£çš„tokençº§åˆ«æµå¼è¾“å‡º
- **å·¥å…·è°ƒç”¨**: ä¸ä½¿ç”¨æµå¼ï¼Œä½†å®æ—¶é€šçŸ¥ç”¨æˆ·å·¥å…·ä½¿ç”¨æƒ…å†µ
- **HILä¸­æ–­**: ä¿æŒåŸæœ‰çš„ä¸­æ–­å¤„ç†æœºåˆ¶

### æŠ€æœ¯å®ç°
- ä½¿ç”¨`stream_mode="messages"`è·å–LLMçš„çœŸå®tokenæµ
- LLMé…ç½®å¯ç”¨`streaming=True`ä»¥æ”¯æŒtokençº§åˆ«æµå¼
- æ¯ä¸ªchunkåŒ…å«AIMessageChunkï¼Œå…¶contentä¸ºå•ä¸ªæˆ–å¤šä¸ªtoken
- é¿å…äº†å‡æµå¼ï¼ˆå…ˆè·å–å®Œæ•´å†…å®¹å†æ¨¡æ‹Ÿæµå¼ï¼‰çš„é—®é¢˜

## ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨æœåŠ¡

1. **å¯åŠ¨æ•°æ®åº“æœåŠ¡**:
```bash
# PostgreSQL
cd docker/postgresql && docker-compose up -d

# Redis  
cd docker/redis && docker-compose up -d
```

2. **å¯åŠ¨åç«¯æœåŠ¡**:
```bash
python 01_backendServer.py
```

3. **å¯åŠ¨å‰ç«¯å®¢æˆ·ç«¯**:
```bash
python 02_frontendServer.py
```

### ä½¿ç”¨æµå¼åŠŸèƒ½

1. å¯åŠ¨å‰ç«¯å®¢æˆ·ç«¯åï¼Œé€‰æ‹©æ¨¡å¼ï¼š
   - `stream`: æµå¼æ¨¡å¼ - å®æ—¶æ˜¾ç¤ºAIå›å¤
   - `normal`: æ™®é€šæ¨¡å¼ - ç­‰å¾…å®Œæ•´å›å¤åæ˜¾ç¤º

2. åœ¨æµå¼æ¨¡å¼ä¸‹ï¼š
   - AIæ–‡æœ¬ä¼šé€å­—ç¬¦å®æ—¶æ˜¾ç¤º
   - å·¥å…·è°ƒç”¨ä¼šç«‹å³æ˜¾ç¤ºé€šçŸ¥
   - ä¿æŒæ‰€æœ‰åŸæœ‰çš„HILåŠŸèƒ½

## APIæ¥å£

### æ–°å¢æ¥å£

#### POST /agent/invoke/stream
æµå¼è°ƒç”¨æ™ºèƒ½ä½“æ¥å£

**è¯·æ±‚å‚æ•°**:
```json
{
    "user_id": "string",
    "session_id": "string", 
    "query": "string",
    "system_message": "string"
}
```

**å“åº”æ ¼å¼**: Server-Sent Events
```
data: {"type": "text_chunk", "content": "Hello", "session_id": "...", "timestamp": 1234567890}

data: {"type": "tool_call", "data": {"tool_calls": [...]}, "session_id": "...", "timestamp": 1234567890}

data: {"type": "completed", "data": {...}, "session_id": "...", "timestamp": 1234567890}
```

## ä¾èµ–è¦æ±‚

### æ–°å¢ä¾èµ–
- `aiohttp`: å¼‚æ­¥HTTPå®¢æˆ·ç«¯ï¼Œç”¨äºå¤„ç†æµå¼å“åº”

### åŸæœ‰ä¾èµ–
- fastapi
- langgraph  
- langchain
- redis
- psycopg
- rich
- ç­‰ç­‰...

## é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ä½ç½®: `utils/config.py`

ä¸»è¦é…ç½®é¡¹ä¸05é¡¹ç›®ä¿æŒä¸€è‡´ï¼š
- æ•°æ®åº“è¿æ¥
- Redisé…ç½®
- LLMé…ç½®
- æ—¥å¿—é…ç½®

## é¡¹ç›®ç»“æ„

```
06_ReActAgentHILApiMultiSessionStreamTest/
â”œâ”€â”€ 01_backendServer.py          # åç«¯æœåŠ¡å™¨ï¼ˆæ–°å¢æµå¼APIï¼‰
â”œâ”€â”€ 02_frontendServer.py         # å‰ç«¯å®¢æˆ·ç«¯ï¼ˆæ–°å¢æµå¼å¤„ç†ï¼‰
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ config.py               # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ llms.py                 # LLMé…ç½®
â”‚   â””â”€â”€ tools.py                # å·¥å…·é…ç½®
â”œâ”€â”€ docker/                     # Dockeré…ç½®
â”œâ”€â”€ docs/                       # æ–‡æ¡£
â”œâ”€â”€ logfile/                    # æ—¥å¿—æ–‡ä»¶
â””â”€â”€ README.md                   # æœ¬æ–‡ä»¶
```

## å¯¹æ¯”05é¡¹ç›®çš„æ”¹è¿›

1. **ç”¨æˆ·ä½“éªŒæå‡**: æµå¼è¿”å›è®©ç”¨æˆ·èƒ½å¤Ÿå®æ—¶çœ‹åˆ°AIæ€è€ƒè¿‡ç¨‹
2. **å“åº”é€Ÿåº¦æ„ŸçŸ¥**: å³ä½¿æ€»æ—¶é—´ç›¸åŒï¼Œæµå¼è¿”å›è®©ç”¨æˆ·æ„Ÿè§‰å“åº”æ›´å¿«
3. **ä¿æŒå…¼å®¹æ€§**: æ”¯æŒåŒæ¨¡å¼ï¼Œç”¨æˆ·å¯æ ¹æ®éœ€è¦é€‰æ‹©
4. **æŠ€æœ¯ç°ä»£åŒ–**: é‡‡ç”¨SSEæ ‡å‡†ï¼Œç¬¦åˆç°ä»£Webåº”ç”¨è¶‹åŠ¿

## æ³¨æ„äº‹é¡¹

1. æµå¼æ¨¡å¼éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥
2. å·¥å…·è°ƒç”¨éƒ¨åˆ†ä¿æŒéæµå¼ï¼Œç¡®ä¿HILåŠŸèƒ½æ­£å¸¸
3. é”™è¯¯å¤„ç†æœºåˆ¶ä¿æŒä¸åŸé¡¹ç›®ä¸€è‡´
4. ä¼šè¯çŠ¶æ€ç®¡ç†é€»è¾‘ä¸å˜

## ä½œè€…

@å—å“¥AGIç ”ä¹ ç¤¾ (Bç«™ or YouTube æœç´¢"å—å“¥AGIç ”ä¹ ç¤¾")

## æ›´æ–°æ—¥å¿—

### v1.0 (åŸºäº05é¡¹ç›®)
- âœ… æ–°å¢æµå¼è¿”å›åŠŸèƒ½
- âœ… æ”¯æŒåŒæ¨¡å¼é€‰æ‹©
- âœ… ä¿æŒæ‰€æœ‰åŸæœ‰åŠŸèƒ½
- âœ… ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

---

# ğŸ“‘ æ­£å¼å‰ç«¯æ¥å£æ–‡æ¡£ï¼ˆAPI Referenceï¼‰

## 1. æ™ºèƒ½ä½“æ™®é€šè°ƒç”¨æ¥å£

### POST `/agent/invoke`

**æè¿°**ï¼šåŒæ­¥è°ƒç”¨æ™ºèƒ½ä½“ï¼Œç­‰å¾…å®Œæ•´å›å¤åä¸€æ¬¡æ€§è¿”å›ã€‚

**è¯·æ±‚å‚æ•°ï¼ˆJSONï¼‰**ï¼š
```json
{
  "user_id": "string",        // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  "session_id": "string",     // ä¼šè¯å”¯ä¸€æ ‡è¯†
  "query": "string",          // ç”¨æˆ·è¾“å…¥å†…å®¹
  "system_message": "string"  // å¯é€‰ï¼Œç³»ç»Ÿæç¤ºè¯
}
```

**å“åº”å‚æ•°ï¼ˆJSONï¼‰**ï¼š
```json
{
  "session_id": "string",
  "status": "completed|interrupted|error",
  "timestamp": 1234567890,
  "message": "string",           // é”™è¯¯æ—¶çš„æç¤º
  "result": { ... },             // æ™ºèƒ½ä½“å®Œæ•´å›å¤ï¼ˆé€šå¸¸åŒ…å«messagesç­‰ç»“æ„ï¼‰
  "interrupt_data": { ... }      // ä¸­æ–­æ—¶çš„è¯¦ç»†ä¿¡æ¯
}
```

---

## 2. æ™ºèƒ½ä½“æµå¼è°ƒç”¨æ¥å£

### POST `/agent/invoke/stream`

**æè¿°**ï¼šæµå¼è°ƒç”¨æ™ºèƒ½ä½“ï¼Œé‡‡ç”¨Server-Sent Events (SSE)åè®®ï¼Œå‰ç«¯å¯å®æ—¶æ¥æ”¶AIå›å¤tokenã€å·¥å…·è°ƒç”¨ç­‰äº‹ä»¶ã€‚

**è¯·æ±‚å‚æ•°ï¼ˆJSONï¼‰**ï¼š
```json
{
  "user_id": "string",        // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  "session_id": "string",     // ä¼šè¯å”¯ä¸€æ ‡è¯†
  "query": "string",          // ç”¨æˆ·è¾“å…¥å†…å®¹
  "system_message": "string"  // å¯é€‰ï¼Œç³»ç»Ÿæç¤ºè¯
}
```

**å“åº”æ ¼å¼**ï¼šSSEæµï¼Œæ¯ä¸ªäº‹ä»¶ä»¥`data: {json}\n\n`æ ¼å¼æ¨é€ã€‚

**æµå¼å—ç±»å‹è¯´æ˜**ï¼š

| type         | è¯´æ˜                   | ä¸»è¦å­—æ®µ         |
|--------------|------------------------|------------------|
| text_chunk   | AIæ–‡æœ¬tokenæµ          | content          |
| tool_call    | å·¥å…·è°ƒç”¨é€šçŸ¥           | data.tool_calls  |
| interrupt    | HILä¸­æ–­                | interrupt_data   |
| completed    | æ‰§è¡Œå®Œæˆï¼Œæœ€ç»ˆç»“æœ      | data             |
| error        | é”™è¯¯ä¿¡æ¯               | error_message    |

**ç¤ºä¾‹å“åº”**ï¼š
```
data: {"type": "text_chunk", "content": "ä½ å¥½", "session_id": "...", "timestamp": 1234567890}

data: {"type": "tool_call", "data": {"tool_calls": [...]}, "session_id": "...", "timestamp": 1234567890}

data: {"type": "completed", "data": {...}, "session_id": "...", "timestamp": 1234567890}
```

---

## 3. ä¼šè¯ä¸ç”¨æˆ·ç®¡ç†æ¥å£

### è·å–ç”¨æˆ·æ‰€æœ‰ä¼šè¯ID
#### GET `/agent/sessionids/{user_id}`
**å“åº”**ï¼š
```json
{
  "session_ids": ["session_id1", "session_id2", ...]
}
```

### è·å–å½“å‰æ´»è·ƒä¼šè¯ID
#### GET `/agent/active/sessionid/{user_id}`
**å“åº”**ï¼š
```json
{
  "active_session_id": "string"
}
```

### æŸ¥è¯¢ä¼šè¯çŠ¶æ€
#### GET `/agent/status/{user_id}/{session_id}`
**å“åº”**ï¼š
```json
{
  "user_id": "string",
  "session_id": "string",
  "status": "not_found|idle|running|interrupted|completed|error",
  "message": "string",
  "last_query": "string",
  "last_updated": 1234567890,
  "last_response": { ... }
}
```

### åˆ é™¤ä¼šè¯
#### DELETE `/agent/session/{user_id}/{session_id}`
**å“åº”**ï¼š
```json
{
  "success": true
}
```

---

## 4. é•¿æœŸè®°å¿†æ¥å£

### å†™å…¥é•¿æœŸè®°å¿†
#### POST `/agent/write/longterm`
**è¯·æ±‚**ï¼š
```json
{
  "user_id": "string",
  "memory_info": "string"
}
```
**å“åº”**ï¼š
```json
{
  "success": true,
  "user_id": "string",
  "message": "string"
}
```

---

## 5. SSEæµå¼å‰ç«¯é›†æˆå»ºè®®

- å»ºè®®ä½¿ç”¨EventSourceï¼ˆWebï¼‰ã€fetch+ReadableStreamï¼ˆç°ä»£Webï¼‰ã€æˆ–ç¬¬ä¸‰æ–¹SSEåº“ç›‘å¬`/agent/invoke/stream`æ¥å£ã€‚
- æ¯æ”¶åˆ°ä¸€æ¡`data: ...`ï¼Œè§£æJSONï¼Œæ ¹æ®typeå­—æ®µåŠ¨æ€æ¸²æŸ“AIå›å¤ã€å·¥å…·è°ƒç”¨ã€å®ŒæˆçŠ¶æ€ç­‰ã€‚
- å·¥å…·è°ƒç”¨å’Œä¸­æ–­äº‹ä»¶å¯ç”¨äºå‰ç«¯å¼¹çª—ã€è¿›åº¦æ¡ã€HILäº¤äº’ç­‰ã€‚

**å‰ç«¯ä¼ªä»£ç ç¤ºä¾‹**ï¼š
```js
const evtSource = new EventSource('/agent/invoke/stream', { withCredentials: true });
evtSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  switch(data.type) {
    case 'text_chunk':
      // å®æ—¶è¿½åŠ AIå›å¤
      break;
    case 'tool_call':
      // æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€
      break;
    case 'completed':
      // å›å¤ç»“æŸï¼Œå±•ç¤ºæœ€ç»ˆç»“æœ
      break;
    case 'interrupt':
      // å¤„ç†HILä¸­æ–­
      break;
    case 'error':
      // æ˜¾ç¤ºé”™è¯¯
      break;
  }
};
```

---

## 6. é”™è¯¯å¤„ç†
- æ‰€æœ‰æ¥å£å‡å¯èƒ½è¿”å›`error`ç±»å‹æˆ–HTTPé”™è¯¯ç ï¼Œå‰ç«¯åº”åšå¥½å¼‚å¸¸æ•è·ä¸å‹å¥½æç¤ºã€‚



